[tox]
min_version = 4.3.3
requires =
    tox-ignore-env-name-mismatch ~= 0.2.0
envlist = py311, py311-external, lint
# CI: skip-next-line
skipsdist = true
# CI: skip-next-line
skip_missing_interpreters = true

# All environments share the same envdir to save space and time
[testenv]
envdir = {toxworkdir}/shared
runner = ignore_env_name_mismatch
# CI: skip-next-line
usedevelop = true
install_command =
  pip install -U {opts} {packages}
setenv =
  VIRTUAL_ENV={envdir}
  LANGUAGE=en_US
  LC_ALL=en_US.utf-8
  PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python
deps = -rrequirements-dev.txt
passenv =
    QISKIT_IBM_CHANNEL
    QISKIT_IBM_TOKEN
    QISKIT_IBM_INSTANCE
    QISKIT_IBM_URL
    GATEWAY_HOST
    GATEWAY_TOKEN
    GATEWAY_INSTANCE

[testenv:py311]
commands =
  pip install -e ../client
  pip check
  python -m pytest -v -s --order-dependencies integration

[testenv:py311-external]
commands =
  pip check
  python -m pytest -v -s --order-dependencies external

[testenv:lint]
skip_install = true
commands =
  black --line-length 120 --diff --check .
  pylint -rn --ignore=source_files integration external

[testenv:black]
skip_install = true
commands = black --line-length 120 .

# PostgreSQL version should match production (currently 15)
[kind]
postgresql_repo = bitnamilegacy/postgresql
postgresql_tag = 15

[testenv:kind-delete]
skip_install = true
allowlist_externals = kind
passenv = KIND_CLUSTER_NAME
commands = kind delete cluster --name {env:KIND_CLUSTER_NAME:qs-test}

[testenv:kind-create]
skip_install = true
allowlist_externals = kind, kubectl
passenv = KIND_CLUSTER_NAME
changedir = {toxinidir}/..
commands =
    kind delete cluster --name {env:KIND_CLUSTER_NAME:qs-test}
    kind create cluster --name {env:KIND_CLUSTER_NAME:qs-test} --config={toxinidir}/kind-config.yaml
    kubectl label node {env:KIND_CLUSTER_NAME:qs-test}-control-plane has-gpu=gpu has-cpu=cpu --overwrite
    kubectl apply -f https://kind.sigs.k8s.io/examples/ingress/deploy-ingress-nginx.yaml

[testenv:kind-build]
skip_install = true
allowlist_externals = docker, kind, helm
passenv = KIND_CLUSTER_NAME
changedir = {toxinidir}/..
commands =
    helm repo add bitnami https://charts.bitnami.com/bitnami
    helm repo add kuberay https://ray-project.github.io/kuberay-helm
    docker build -t gateway:test -f gateway/Dockerfile .
    docker build --build-arg \
        DYNAMIC_DEPENDENCIES_FILE=requirements-test-dynamic-dependencies.txt \
        -t ray:test -f ray-node/Dockerfile .
    kind load docker-image ray:test --name {env:KIND_CLUSTER_NAME:qs-test}
    kind load docker-image gateway:test --name {env:KIND_CLUSTER_NAME:qs-test}

[testenv:kind-deploy]
skip_install = true
allowlist_externals = helm, kubectl
changedir = {toxinidir}/../charts/qiskit-serverless
commands =
    helm dependency build
    helm upgrade --install qs \
    --set platform=kind \
    --set nginxIngressControllerEnable=false \
    --set gateway.image.repository=gateway \
    --set gateway.image.tag=test \
    --set gateway.application.ray.nodeImage=ray:test \
    --set gateway.application.ray.cpu=1 \
    --set gateway.application.ray.memory=3 \
    --set gateway.application.debug=1 \
    --set gateway.application.limits.keepClusterOnComplete=false \
    --set gateway.application.authMockproviderRegistry=test \
    --set gateway.application.dependencies.dynamicDependencies=requirements-test-dynamic-dependencies.txt \
    --set ingress.hosts[0].host=localhost \
    --set ingress.hosts[0].paths[0].path=/ \
    --set ingress.hosts[0].paths[0].pathType=Prefix \
    --set ingress.hosts[0].paths[0].serviceName=gateway \
    --set ingress.hosts[0].paths[0].servicePort=8000 \
    --set postgresql.image.repository={[kind]postgresql_repo} \
    --set postgresql.image.tag={[kind]postgresql_tag} \
    --set postgresql.image.pullPolicy=IfNotPresent \
    --set postgresql.volumePermissions.image.repository=bitnamilegacy/os-shell \
    --set postgresql.volumePermissions.image.pullPolicy=IfNotPresent \
    --set postgresql.metrics.image.repository=bitnamilegacy/postgres-exporter \
    --set postgresql.metrics.image.pullPolicy=IfNotPresent \
    .
    kubectl patch svc gateway -p '{"spec": {"type": "LoadBalancer"}}'

[testenv:kind-wait]
skip_install = true
allowlist_externals = kubectl
commands =
    kubectl wait --for=condition=ready pod --selector=app.kubernetes.io/name=gateway-scheduler --timeout=5m
    kubectl wait --for=condition=ready pod --selector=app.kubernetes.io/name=gateway --timeout=5m
    kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=5m
